<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Détails patient</title>
    <style>
        .note-item{margin-bottom:10px}
        .note-text{display:inline-block;margin-right:10px}
        .note-edit{display:none;margin-top:6px}
        .note-actions button{margin-right:6px}
        .note-actions form{display:inline}
    </style>
</head>
<body>
<h1 th:text="'Détails du patient ' + ${patient.firstName} + ' ' + ${patient.lastName}"></h1>
<p><a th:href="@{/patients}">Retour à la liste</a></p>

<h2>Informations</h2>
<form th:action="@{/patients/{id}/update(id=${patient.id})}" th:object="${patientForm}" method="post">
    <div><label>Nom:</label><input type="text" th:field="*{lastName}"/></div>
    <div><label>Prénom:</label><input type="text" th:field="*{firstName}"/></div>
    <div><label>Date de naissance:</label><input type="date" th:field="*{birthDate}"/></div>
    <div><label>Sexe (M/F):</label><input type="text" th:field="*{gender}"/></div>
    <div><label>Adresse:</label><input type="text" th:field="*{address}"/></div>
    <div><label>Téléphone:</label><input type="text" th:field="*{phone}"/></div>
    <button type="submit">Mettre à jour</button>
</form>

<h2>Évaluation du risque</h2>
<div th:if="${assessment != null}">
    <p><strong>Âge:</strong> <span th:text="${assessment.age}"></span></p>
    <p><strong>Nombre de déclencheurs:</strong> <span th:text="${assessment.triggerCount}"></span></p>
    <p><strong>Niveau de risque:</strong> <span th:text="${assessment.riskLevel}"></span></p>
</div>
<div th:if="${assessment == null}">
    <p>Impossible de calculer le risque pour ce patient.</p>
</div>

<h2>Notes</h2>

<!-- Liste + édition inline -->
<div th:if="${notes != null and !notes.isEmpty()}">
    <div th:each="n : ${notes}" class="note-item" th:attr="data-id=${n.id}">
        <span class="note-text" th:text="${n.note}"></span>

        <span class="note-actions">
            <!-- Modifier (affiche/masque le formulaire d’édition) -->
            <button type="button" th:attr="data-target=${'edit-'+n.id}" onclick="toggleEdit(this)">Modifier</button>

            <!-- Supprimer -->
            <form th:action="@{|/patients/${patient.id}/notes/${n.id}/delete|}" method="post">
                <button type="submit" onclick="return confirm('Supprimer cette note ?');">Supprimer</button>
            </form>
        </span>

        <!-- Formulaire d’édition caché par défaut -->
        <form class="note-edit"
              th:id="${'edit-'+n.id}"
              th:action="@{/patients/{id}/notes/{noteId}/update(id=${patient.id}, noteId=${n.id})}"
              method="post">
            <input type="hidden" name="patientId" th:value="${patient.id}">
            <textarea name="note" rows="3" cols="60" th:text="${n.note}"></textarea>
            <div>
                <button type="submit">Enregistrer</button>
                <button type="button" onclick="toggleEdit(this)" data-cancel>Annuler</button>
            </div>
        </form>
    </div>
</div>
<div th:if="${notes == null or notes.isEmpty()}">
    <p>Aucune note pour l’instant.</p>
</div>

<h3>Ajouter une note</h3>
<form th:action="@{/patients/{id}/notes(id=${patient.id})}" th:object="${noteForm}" method="post">
    <input type="hidden" th:field="*{patientId}" th:value="${patient.id}" />
    <div>
        <textarea th:field="*{note}" rows="4" cols="50"></textarea>
        <span th:if="${#fields.hasErrors('note')}" th:errors="*{note}"></span>
    </div>
    <div>
        <button type="submit">Enregistrer la note</button>
    </div>
</form>

<script>
    function toggleEdit(btn){
      const id = btn.getAttribute('data-target') || btn.closest('.note-item').querySelector('.note-edit').id;
      const form = document.getElementById(id);
      form.style.display = form.style.display === 'block' ? 'none' : 'block';
    }
</script>
</body>
</html>